#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Markdown —Ä–µ–∑—é–º–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ example.json –∫–∞–∫ —à–∞–±–ª–æ–Ω.
"""

import sys
import os
import json
import argparse
from pathlib import Path

try:
    from google import genai
except ImportError:
    print("–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ google-genai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")
    print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ—ë –∫–æ–º–∞–Ω–¥–æ–π: pip install google-genai")
    sys.exit(1)


DEFAULT_GEMINI_MODEL = "gemini-2.5-flash"


def read_file(file_path):
    """
    –ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    
    Args:
        file_path (str): –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
        
    Returns:
        str: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
    """
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            return f.read()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {file_path}: {e}")
        sys.exit(1)


def load_json_template(template_path):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç JSON —à–∞–±–ª–æ–Ω.
    
    Args:
        template_path (str): –ü—É—Ç—å –∫ JSON —à–∞–±–ª–æ–Ω—É
        
    Returns:
        dict: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON
    """
    try:
        content = read_file(template_path)
        return json.loads(content)
    except json.JSONDecodeError as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON —à–∞–±–ª–æ–Ω–∞: {e}")
        sys.exit(1)


def create_extraction_prompt(markdown_content, json_template):
    """
    –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ MD –≤ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
    
    Args:
        markdown_content (str): –°–æ–¥–µ—Ä–∂–∏–º–æ–µ MD —Ñ–∞–π–ª–∞
        json_template (dict): JSON —à–∞–±–ª–æ–Ω
        
    Returns:
        str: –ü—Ä–æ–º–ø—Ç –¥–ª—è –º–æ–¥–µ–ª–∏
    """
    template_str = json.dumps(json_template, ensure_ascii=False, indent=2)
    
    prompt = f"""–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–∑—é–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∑–∞–ø–æ–ª–Ω–∏—Ç—å JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∑—é–º–µ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–π –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
2. –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏, –¥–∞—Ç—ã, –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–π, –ø—Ä–æ–µ–∫—Ç—ã –∏–ª–∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
3. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–Ω–µ—à–Ω–∏–µ –∑–Ω–∞–Ω–∏—è –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
4. –ò–∑–≤–ª–µ–∫–∞–π –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ
5. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ, –æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–µ –ø—É—Å—Ç—ã–º (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ "" –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ [])
6. –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ –¥–∞—Ç—ã, –Ω–∞–∑–≤–∞–Ω–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –Ω–∞–≤—ã–∫–∏ —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
7. –î–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞, –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Å–≤–æ–∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è

–°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –û–¢–î–ï–õ–¨–ù–´–• –ü–û–õ–ï–ô:

–ü–û–õ–ï "full_name" (–§–ò–û):
- –ò–∑–≤–ª–µ–∫–∏ –ø–æ–ª–Ω–æ–µ –∏–º—è (–§–ò–û) –∏–∑ —Ä–µ–∑—é–º–µ
- –ò—â–∏ –∏–º—è –≤ –Ω–∞—á–∞–ª–µ —Ä–µ–∑—é–º–µ, –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏–ª–∏ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ï—Å–ª–∏ –§–ò–û –Ω–µ —É–∫–∞–∑–∞–Ω–æ —è–≤–Ω–æ, –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º

–ü–û–õ–ï "project_background" (–ø—Ä–æ–µ–∫—Ç–Ω—ã–π –±–µ–∫–≥—Ä–∞—É–Ω–¥):
- –£–∫–∞–∂–∏ 1-3 –∫–ª—é—á–µ–≤—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –¥–æ–º–µ–Ω—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç
- –§–æ—Ä–º–∞—Ç: –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –±–µ–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏—è)
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—á–Ω–∏ —Å —Ç–∏–ø–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û", "Backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"), –∑–∞—Ç–µ–º –ø–µ—Ä–µ—á–∏—Å–ª–∏ –æ—Ç—Ä–∞—Å–ª–∏/–¥–æ–º–µ–Ω—ã
- –ü—Ä–∏–º–µ—Ä—ã: "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û, –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ", "Backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, —Ñ–∏–Ω—Ç–µ—Ö", "Full-stack —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, e-commerce, –º–µ–¥–∏–∞"
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–µ–∑—é–º–µ –æ —Ç–∏–ø–∞—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ä–µ–∑—é–º–µ

–ü–û–õ–ï "pitch" (—Ä–∞—Å—Å–∫–∞–∑ –æ —Å–µ–±–µ):
- –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Ç—á –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (—è/–º–µ–Ω—è/–º–Ω–µ) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —Ä–µ–∑—é–º–µ
- –†–∞–∑–º–µ—Ä: 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (—Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä)
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ, –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–≤—ã–∫–∞—Ö –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö –∏–∑ —Ä–µ–∑—é–º–µ
- –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –∫–∞–∫ –±—É–¥—Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç —Å–∞–º —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Å–µ–±–µ
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ä–µ–∑—é–º–µ
- –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç "–æ —Å–µ–±–µ", –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –∫–∞–∫ –æ—Å–Ω–æ–≤—É, –Ω–æ –ø–µ—Ä–µ–ø–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞

–ü–û–õ–ï "soft_skills" (–≤ —Ä–∞–∑–¥–µ–ª–µ screening):
- –ò–∑–≤–ª–µ–∫–∏ soft skills (–º—è–≥–∫–∏–µ –Ω–∞–≤—ã–∫–∏) –∏–∑ —Ä–µ–∑—é–º–µ
- –ò—â–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤–∞—Ö, –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–∞—Ö, –ª–∏–¥–µ—Ä—Å—Ç–≤–µ, —Ä–∞–±–æ—Ç–µ –≤ –∫–æ–º–∞–Ω–¥–µ –∏ —Ç.–¥.
- –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã soft skills - –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö
- –ï—Å–ª–∏ soft skills –Ω–µ —É–∫–∞–∑–∞–Ω—ã —è–≤–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –æ–ø—ã—Ç–∞ —Ä–∞–±–æ—Ç—ã –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ - –∏–∑–≤–ª–µ–∫–∏ –∏—Ö
- –ü—Ä–∏–º–µ—Ä—ã: "–∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞", "–ª–∏–¥–µ—Ä—Å—Ç–≤–æ", "–∫–æ–º–º—É–Ω–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å", "—Å—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å", "–∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å"
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π soft skills, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ –∏–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã–≤–µ—Å—Ç–∏ –∏–∑ –æ–ø—ã—Ç–∞

–ü–û–õ–ï "skills_and_tools" (–Ω–∞–≤—ã–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ general_info):
- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –≠—Ç–æ –ø–æ–ª–µ –¢–û–õ–¨–ö–û –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç –£–ú–ï–ï–¢ –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨
- –ù–ï –≤–∫–ª—é—á–∞–π —Å—é–¥–∞:
  * –ö—É—Ä—Å—ã, –æ–±—É—á–µ–Ω–∏–µ, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (—ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø–æ–ª–µ "education")
  * –ù–∞–∑–≤–∞–Ω–∏—è —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤, –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º (Coursera, –ú–§–¢–ò, –Ø–Ω–¥–µ–∫—Å –∏ —Ç.–¥.)
  * –ù–∞–∑–≤–∞–Ω–∏—è —É—á–µ–±–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º –∏–ª–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω
  * –õ—é–±—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏
- –í–∫–ª—é—á–∞–π –¢–û–õ–¨–ö–û:
  * –Ø–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è (Python, Java, JavaScript –∏ —Ç.–¥.)
  * –§—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Django, React, Flask –∏ —Ç.–¥.)
  * –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (Git, Docker, Kubernetes –∏ —Ç.–¥.)
  * –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL, MongoDB –∏ —Ç.–¥.)
  * –û–±–ª–∞—á–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (AWS, Azure, GCP –∏ —Ç.–¥.)
  * –î—Ä—É–≥–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞–±–æ—Ç–µ
- –ì—Ä—É–ø–ø–∏—Ä—É–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è1, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è2, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è3"
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—ã–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ):
  * "–Ø–∑—ã–∫ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è" –∏–ª–∏ "–Ø–∑—ã–∫–∏ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è" - –¥–ª—è —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è (Python, Java, JavaScript, C++, Go, Rust –∏ —Ç.–¥.)
  * "–§—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Web)" - –¥–ª—è –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫ (Flask, Django, React, Vue, Express –∏ —Ç.–¥.)
  * "–ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö (–°–£–ë–î)" - –¥–ª—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL, MySQL, MongoDB, Redis, Cassandra –∏ —Ç.–¥.)
  * "–û–±–ª–∞—á–Ω—ã–µ –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã (Cloud)" - –¥–ª—è –æ–±–ª–∞—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (AWS, Azure, GCP, Heroku –∏ —Ç.–¥.)
  * "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è" - –¥–ª—è Docker, Kubernetes, Docker Compose –∏ —Ç.–¥.
  * "–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ó–∞–¥–∞—á–∏ / –û–±–º–µ–Ω –°–æ–æ–±—â–µ–Ω–∏—è–º–∏" - –¥–ª—è Celery, RabbitMQ, Kafka, SQS –∏ —Ç.–¥.
  * "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏" - –¥–ª—è Git, CI/CD –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, —Å–∏—Å—Ç–µ–º —Å–±–æ—Ä–∫–∏ –∏ —Ç.–¥.
  * "–î—Ä—É–≥–∏–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ / –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏" - –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ (REST API, GraphQL, ML —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ —Ç.–¥.)
- –ö–∞–∂–¥–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º –º–∞—Å—Å–∏–≤–∞
- –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:
  [
    "–Ø–∑—ã–∫ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è: Python",
    "–§—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Web): Flask, Django, Django Rest Framework, FastAPI",
    "–ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö (–°–£–ë–î): PostgreSQL, Redis",
    "–û–±–ª–∞—á–Ω—ã–µ –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã (Cloud): Amazon Web Services, Google Cloud Platform, Azure",
    "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è: Docker, kubernetes",
    "–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ó–∞–¥–∞—á–∏ / –û–±–º–µ–Ω –°–æ–æ–±—â–µ–Ω–∏—è–º–∏: Celery, RabbitMQ",
    "–î—Ä—É–≥–∏–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ / –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏: REST API, PyTorch"
  ]
- –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —É–∫–∞–∑–∞–Ω—ã –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≥—Ä—É–ø–ø–∏—Ä—É–π –∏—Ö –ª–æ–≥–∏—á–µ—Å–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ä–µ–∑—é–º–µ
- –ï—Å–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –≤—ã–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é

–ü–û–õ–ï "education" (–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ general_info):
- –ò–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏: —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã, –∫—É—Ä—Å—ã, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –æ–±—É—á–µ–Ω–∏–µ
- –í–∫–ª—é—á–∞–π:
  * –í—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å, –≥–æ–¥—ã)
  * –ö—É—Ä—Å—ã –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
  * –û–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã (Coursera, edX, Udemy –∏ —Ç.–¥.)
  * –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –¥–∏–ø–ª–æ–º—ã
  * –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
  * –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã –∏ —Ç—Ä–µ–Ω–∏–Ω–≥–∏
- –§–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞: "–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞/–ø—Ä–æ–≥—Ä–∞–º–º—ã, –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è" –∏–ª–∏ "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å, –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç"
- –ü—Ä–∏–º–µ—Ä—ã:
  * "–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –Ø–Ω–¥–µ–∫—Å"
  * "Deep Learning, –ú–§–¢–ò"
  * "Introduction to Cryptocurrency, Coursera"
  * "Model Thinking, Coursera"
  * "Computing for Data Analysis, Coursera"
  * "Think Again: How to Reason and Argue, Coursera"
- –ù–ï –≤–∫–ª—é—á–∞–π —Å—é–¥–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ "skills_and_tools")
- –ï—Å–ª–∏ –≤ —Ä–µ–∑—é–º–µ –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ" –∏–ª–∏ "–ö—É—Ä—Å—ã", –∏–∑–≤–ª–µ–∫–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç—Ç—É–¥–∞

–ü–û–õ–ï "technologies" (–≤ work_experience) –∏ "technologies_and_tools" (–≤ project_experience):
- –ò–∑–≤–ª–µ–∫–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –º–µ—Å—Ç–µ —Ä–∞–±–æ—Ç—ã
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –ö–ê–ñ–î–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–∫–∞–∑–∞–Ω–æ "–§—Ä–µ–π–º–≤–æ—Ä–∫–∏: Flask, Django", –∑–∞–ø–∏—Å—ã–≤–∞–π —Ç–æ–ª—å–∫–æ "Flask" –∏ "Django" –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞
- –†–∞–∑–¥–µ–ª—è–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞ (–Ω–µ –æ–±—ä–µ–¥–∏–Ω—è–π –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É)
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —Ä–∞–±–æ—Ç—ã

–ü–û–õ–ï "achievements" (–≤ –∫–∞–∂–¥–æ–º –æ–±—ä–µ–∫—Ç–µ work_experience, work_experience[].projects –∏ project_experience):
- –ó–∞–ø–æ–ª–Ω—è–π —Å–ø–∏—Å–∫–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (—É–ª—É—á—à–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫, —Ä–æ—Å—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π)
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∑—é–º–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π
- –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –Ω–µ—Ç, –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å:
{template_str}

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ:
{markdown_content}

–ó–∞–ø–æ–ª–Ω–∏ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ä–µ–∑—é–º–µ. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ï—Å–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ, –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º."""
    
    return prompt


def extract_json_from_response(response_text):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏.
    
    Args:
        response_text (str): –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏
        
    Returns:
        dict: –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON
    """
    # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ (–º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏—è)
    response_text = response_text.strip()
    
    # –ò—â–µ–º –Ω–∞—á–∞–ª–æ JSON (–ø–µ—Ä–≤–∞—è {)
    start_idx = response_text.find('{')
    if start_idx == -1:
        raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞—á–∞–ª–æ JSON –≤ –æ—Ç–≤–µ—Ç–µ")
    
    # –ò—â–µ–º –∫–æ–Ω–µ—Ü JSON (–ø–æ—Å–ª–µ–¥–Ω—è—è })
    end_idx = response_text.rfind('}')
    if end_idx == -1 or end_idx < start_idx:
        raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω–µ—Ü JSON –≤ –æ—Ç–≤–µ—Ç–µ")
    
    json_str = response_text[start_idx:end_idx + 1]
    
    try:
        return json.loads(json_str)
    except json.JSONDecodeError as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞: {e}")
        print(f"–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: {json_str[:500]}...")
        raise


def process_with_gemini(markdown_content, json_template, api_key, model_name=None):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ AI API (Gemini –∏–ª–∏ OpenRouter) –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ JSON.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ OpenRouter –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Gemini (503, 500, 429).
    
    Args:
        markdown_content (str): –°–æ–¥–µ—Ä–∂–∏–º–æ–µ MD —Ñ–∞–π–ª–∞
        json_template (dict): JSON —à–∞–±–ª–æ–Ω
        api_key (str): API –∫–ª—é—á Gemini (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        model_name (str): –ò–º—è –º–æ–¥–µ–ª–∏ Gemini (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: gemini-2.5-flash)
        
    Returns:
        dict: –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    """
    try:
        from parser.ai_provider import process_with_fallback, get_api_keys
    except ImportError:
        # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        print("‚ö†Ô∏è  –ú–æ–¥—É–ª—å ai_provider –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Gemini")
        return _process_with_gemini_legacy(markdown_content, json_template, api_key, model_name)
    
    # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á–∏
    env_keys = get_api_keys()
    gemini_key = api_key or env_keys['gemini']
    openrouter_key = env_keys['openrouter']
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback
    try:
        return process_with_fallback(
            markdown_content,
            json_template,
            create_extraction_prompt,
            gemini_api_key=gemini_key,
            openrouter_api_key=openrouter_key,
            gemini_model=model_name,
            verbose=True
        )
    except Exception as e:
        # –ï—Å–ª–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
        if gemini_key:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é: {e}")
            return _process_with_gemini_legacy(markdown_content, json_template, gemini_key, model_name)
        raise


def _process_with_gemini_legacy(markdown_content, json_template, api_key, model_name=None):
    """
    –°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ Gemini API (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏).
    
    Args:
        markdown_content (str): –°–æ–¥–µ—Ä–∂–∏–º–æ–µ MD —Ñ–∞–π–ª–∞
        json_template (dict): JSON —à–∞–±–ª–æ–Ω
        api_key (str): API –∫–ª—é—á Gemini
        model_name (str): –ò–º—è –º–æ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: gemini-2.5-flash)
        
    Returns:
        dict: –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    """
    model_name = model_name or DEFAULT_GEMINI_MODEL
    
    prompt = create_extraction_prompt(markdown_content, json_template)
    
    print("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Gemini API...")
    print(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å: {model_name}")
    
    try:
        client = genai.Client(api_key=api_key)
    except Exception as config_error:
        print(f"–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Gemini API: {config_error}")
        raise
    
    try:
        response = client.models.generate_content(
            model=model_name,
            contents=prompt,
        )
    except Exception as api_error:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini API: {api_error}")
        raise
    
    response_text = getattr(response, "text", None)
    if not response_text:
        # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ —á–∞—Å—Ç–µ–π –æ—Ç–≤–µ—Ç–∞
        try:
            candidates = getattr(response, "candidates", [])
            for candidate in candidates:
                for part in candidate.content.parts:
                    if getattr(part, "text", None):
                        response_text = part.text
                        break
                if response_text:
                    break
        except Exception:
            response_text = None
    
    if not response_text:
        print("–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini API.")
        raise RuntimeError("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini API")
    
    try:
        extracted_json = extract_json_from_response(response_text)
        return extracted_json
    except (ValueError, json.JSONDecodeError) as parse_error:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ Gemini: {parse_error}")
        print("–û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏:")
        print(response_text)
        raise


def merge_with_template(extracted_data, template):
    """
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —à–∞–±–ª–æ–Ω–æ–º, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É —à–∞–±–ª–æ–Ω–∞.
    
    Args:
        extracted_data (dict): –î–∞–Ω–Ω—ã–µ, –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª—å—é
        template (dict): –ò—Å—Ö–æ–¥–Ω—ã–π —à–∞–±–ª–æ–Ω
        
    Returns:
        dict: –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    """
    def deep_merge(source, target):
        """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–≤–∞ —Å–ª–æ–≤–∞—Ä—è."""
        if isinstance(source, dict) and isinstance(target, dict):
            result = target.copy()
            for key, value in source.items():
                if key in result:
                    if isinstance(value, dict) and isinstance(result[key], dict):
                        result[key] = deep_merge(value, result[key])
                    elif isinstance(value, list) and isinstance(result[key], list):
                        # –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ source, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
                        result[key] = value if value else result[key]
                    else:
                        # –î–ª—è –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –±–µ—Ä–µ–º –∏–∑ source, –µ—Å–ª–∏ –Ω–µ –ø—É—Å—Ç–æ–µ
                        result[key] = value if value else result[key]
                else:
                    result[key] = value
            return result
        return source if source else target
    
    return deep_merge(extracted_data, template)


def save_json(data, output_path):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–∞–π–ª.
    
    Args:
        data (dict): –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        output_path (str): –ü—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    try:
        with open(output_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"\n‚úÖ JSON —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_path}")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
        sys.exit(1)


def get_api_key():
    """
    –ü–æ–ª—É—á–∞–µ—Ç API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ñ–∞–π–ª–∞.
    
    Returns:
        str: API –∫–ª—é—á
    """
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
    api_key = os.getenv("GEMINI_API_KEY")
    
    if api_key:
        return api_key
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª .env
    env_file = Path(".env")
    if env_file.exists():
        try:
            with open(env_file, 'r', encoding='utf-8') as f:
                for line in f:
                    if line.startswith("GEMINI_API_KEY="):
                        return line.split("=", 1)[1].strip().strip('"').strip("'")
        except:
            pass
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏
    print("\n‚ö†Ô∏è  API –∫–ª—é—á Gemini –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    print("–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ https://aistudio.google.com/app/apikey")
    print("–í—ã –º–æ–∂–µ—Ç–µ:")
    print("  1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è: set GEMINI_API_KEY=your_key")
    print("  2. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª .env —Å —Å—Ç—Ä–æ–∫–æ–π: GEMINI_API_KEY=your_key")
    print("  3. –í–≤–µ—Å—Ç–∏ –∫–ª—é—á —Å–µ–π—á–∞—Å (–æ–Ω –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω)")
    
    api_key = input("\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Gemini API –∫–ª—é—á: ").strip()
    
    if not api_key:
        print("–û—à–∏–±–∫–∞: API –∫–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã.")
        sys.exit(1)
    
    return api_key


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    parser = argparse.ArgumentParser(
        description="–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Markdown —Ä–µ–∑—é–º–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Gemini",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  python md_to_json.py document.md
  python md_to_json.py document.md --template example.json
  python md_to_json.py document.md --output result.json
  python md_to_json.py document.md --model gemini-2.5-flash
  python md_to_json.py document.md --template example.json --output result.json --model gemini-2.5-pro

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è gemini-2.5-flash.
–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è API –∫–ª—é—á–∞: https://aistudio.google.com/app/apikey
–ü—Ä–∏–º–µ—Ä—ã –º–æ–¥–µ–ª–µ–π: gemini-2.5-flash, gemini-2.5-pro, gemini-1.5-pro-exp
        """
    )
    
    parser.add_argument("input_file", help="–ü—É—Ç—å –∫ –≤—Ö–æ–¥–Ω–æ–º—É Markdown —Ñ–∞–π–ª—É")
    parser.add_argument(
        "--template", "-t",
        default="parser/template/example.json",
        help="–ü—É—Ç—å –∫ JSON —à–∞–±–ª–æ–Ω—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: parser/template/example.json)"
    )
    parser.add_argument(
        "--output", "-o",
        help="–ü—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É JSON —Ñ–∞–π–ª—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <–∏–º—è_—Ñ–∞–π–ª–∞>.json)"
    )
    parser.add_argument(
        "--model", "-m",
        default=DEFAULT_GEMINI_MODEL,
        help="–ò–º—è –º–æ–¥–µ–ª–∏ Gemini (–Ω–∞–ø—Ä–∏–º–µ—Ä: gemini-1.5-flash). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è gemini-1.5-flash."
    )
    parser.add_argument(
        "--api-key",
        help="Gemini API –∫–ª—é—á (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é GEMINI_API_KEY)"
    )
    
    args = parser.parse_args()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    if not os.path.exists(args.input_file):
        print(f"–û—à–∏–±–∫–∞: —Ñ–∞–π–ª '{args.input_file}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        sys.exit(1)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–±–ª–æ–Ω–∞
    if not os.path.exists(args.template):
        print(f"–û—à–∏–±–∫–∞: —à–∞–±–ª–æ–Ω '{args.template}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        sys.exit(1)
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    if args.output:
        output_path = args.output
    else:
        input_file = Path(args.input_file)
        output_path = input_file.stem + ".json"
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞
    api_key = args.api_key or get_api_key()
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞
    print(f"–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞: {args.template}")
    json_template = load_json_template(args.template)
    print(f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–±–ª–æ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
    
    # –ß—Ç–µ–Ω–∏–µ MD —Ñ–∞–π–ª–∞
    print(f"–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {args.input_file}")
    markdown_content = read_file(args.input_file)
    print(f"–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(markdown_content)} —Å–∏–º–≤–æ–ª–æ–≤")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ API
    extracted_data = process_with_gemini(
        markdown_content,
        json_template,
        api_key,
        args.model
    )
    
    # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —à–∞–±–ª–æ–Ω–æ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    final_data = merge_with_template(extracted_data, json_template)
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    save_json(final_data, output_path)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:")
    print(f"  - –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã: {len(final_data.get('work_experience', []))} –∑–∞–ø–∏—Å–µ–π")
    print(f"  - –ü—Ä–æ–µ–∫—Ç—ã: {len(final_data.get('project_experience', []))} –∑–∞–ø–∏—Å–µ–π")
    skills_count = len(final_data.get('general_info', {}).get('skills_and_tools', []))
    print(f"  - –ù–∞–≤—ã–∫–∏: {skills_count} –∑–∞–ø–∏—Å–µ–π")


if __name__ == "__main__":
    main()
